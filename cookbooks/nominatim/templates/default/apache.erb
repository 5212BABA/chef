# DO NOT EDIT - This file is being maintained by Chef

<% [80, 443].each do |port| -%>
<VirtualHost *:<%= port %>>
    ServerName nominatim.openstreetmap.org
    ServerAdmin webmaster@openstreetmap.org
    ServerAlias nominatim.osm.org
    ServerAlias nominatim.openstreetmap.org
    ServerAlias nominatim.openstreetmap.net
    ServerAlias nominatim.openstreetmaps.org
    ServerAlias nominatim.openmaps.org

<% if port == 443 -%>
    #
    # Enable SSL
    #
    SSLEngine on
<% end -%>

    CustomLog /var/log/apache2/nominatim.openstreetmap.org-access.log combined
    ErrorLog /var/log/apache2/nominatim.openstreetmap.org-error.log

    DocumentRoot <%= @directory %>/website
    <Directory "<%= @directory %>/website/">
        DirectoryIndex search.php
        Options MultiViews FollowSymLinks
        AddType text/html   .php
        AddType application/xml   .phpx
        AddType application/json   .phpj
<% if node[:lsb][:release].to_f >= 14.04 -%>
        ProxyPassMatch ^/(.*\.php(/.*)?)$ unix:/var/run/php5-fpm-www.sock|fcgi://localhost<%= @directory %>/website/
        ProxyPassMatch ^/(.*\.phpx(/.*)?)$ unix:/var/run/php5-fpm-www.sock|fcgi://localhost<%= @directory %>/website/
        ProxyPassMatch ^/(.*\.phpj(/.*)?)$ unix:/var/run/php5-fpm-www.sock|fcgi://localhost<%= @directory %>/website/
<% else -%>
        AddHandler fcgi:/var/run/php5-fpm-www.sock .php
        AddHandler fcgi:/var/run/php5-fpm-www.sock .phpx
        AddHandler fcgi:/var/run/php5-fpm-www.sock .phpj
<% end -%>
    </Directory>

    <% @pools.each do |name,details| -%>
    Alias /pool-<%= name %>/ "<%= @directory %>/website/"
    <Location /pool-<%= name %>>
<% if node[:lsb][:release].to_f >= 14.04 -%>
        ProxyPassMatch ^/(.*\.php(/.*)?)$ unix:/var/run/php5-fpm-<%= name %>.sock|fcgi://localhost<%= @directory %>/website/
        ProxyPassMatch ^/(.*\.phpx(/.*)?)$ unix:/var/run/php5-fpm-<%= name %>.sock|fcgi://localhost<%= @directory %>/website/
        ProxyPassMatch ^/(.*\.phpj(/.*)?)$ unix:/var/run/php5-fpm-<%= name %>.sock|fcgi://localhost<%= @directory %>/website/
<% else -%>
        AddHandler fcgi:/var/run/php5-fpm-<%= name %>.sock .php
        AddHandler fcgi:/var/run/php5-fpm-<%= name %>.sock .phpx
        AddHandler fcgi:/var/run/php5-fpm-<%= name %>.sock .phpj
<% end -%>
    </Location>
    <% end -%>

    Redirect 420 /pool-block/
    ErrorDocument 420 /509.html
    <Location /pool-block>
        ErrorDocument 420 /509.html
    </Location>
    Redirect 403 /pool-ban/
    <Location /pool-ban>
        ErrorDocument 403 /403.html
    </Location>
    ErrorDocument 403 /403.html

    RewriteEngine On

    # manual blocks
    Include <%= @directory %>/settings/apache_blocks.conf

    # regular requests and autoblocks
    RewriteMap bulklist txt:<%= @directory %>/settings/ip_blocks.map
    RewriteRule ^/([sdr].*) /pool-${bulklist:%{REMOTE_ADDR}|www}/$1 [PT]

</VirtualHost>

<% end -%>
