# DO NOT EDIT - This file is being maintained by Chef

global:
  scrape_interval: 15s
  evaluation_interval: 15s

alerting:
  alertmanagers:
    - path_prefix: /alertmanager
      static_configs:
        - targets:
            - localhost:9093

rule_files:
  - /etc/prometheus/*_rules.yml

scrape_configs:
  - job_name: prometheus
    scrape_interval: 5s
    scrape_timeout: 5s
    metrics_path: /prometheus/metrics
    static_configs:
      - targets:
          - localhost:9090
  - job_name: alertmanager
    metrics_path: /alertmanager/metrics
    static_configs:
      - targets:
          - localhost:9093
<% @jobs.sort.each do |name, targets| -%>
  - job_name: <%= name %>
    static_configs:
<% targets.each do |target| -%>
      - targets:
          - "<%= target[:address] %>"
        labels:
          instance: <%= target[:instance] %>
<% end -%>
    metric_relabel_configs:
<% targets.each do |target| -%>
<% target[:metric_relabel].each do |relabel| -%>
      - source_labels: [instance,<%= relabel[:source_labels] %>]
        regex: "<%= target[:instance] %>;<%= relabel[:regex] %>"
        action: <%= relabel[:action] %>
<% end -%>
<% end -%>
<% end -%>

remote_write:
  - url: "http://localhost:9201/write"
    write_relabel_configs:
      - source_labels: [__name__]
        regex: "go_.*"
        action: drop
      - source_labels: [__name__]
        regex: "promhttp_.*"
        action: drop
    queue_config:
      capacity: 10000
      min_shards: 4
      batch_send_deadline: 30s
      max_backoff: 1s
