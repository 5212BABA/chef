#!/bin/bash

# DO NOT EDIT - This file is being maintained by Chef

# Send output to the log
exec > /var/log/tile/renderd-lowzoom.log 2>&1
<% node[:tile][:styles].each do |name,details| -%>

# Find project file for style "<%= name %>"
project="/srv/tile.openstreetmap.org/styles/<%= name %>/project.mml"

# Update low zoom tiles for style "<%= name %>"
render_old \
  --config=/etc/renderd.conf \
  --tile-dir=/srv/tile.openstreetmap.org/tiles \
  --socket=/var/run/renderd/renderd.sock \
  --num-threads=<%= ( node[:cpu][:total] - 2 ) / 4 %> \
  --map="<%= name %>" \
  --timestamp=$(stat --printf=%Y ${project}) \
  --min-zoom=0 --max-zoom=10

# Update timestamp for style "<%= name %>"
touch --reference="$project" "/srv/tile.openstreetmap.org/tiles/<%= name %>/planet-import-complete"
<% end -%>

exit 0
