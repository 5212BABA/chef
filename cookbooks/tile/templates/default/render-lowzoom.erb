#!/bin/bash

# DO NOT EDIT - This file is being maintained by Chef

# Send output to the log
exec > /var/log/tile/render-lowzoom.log 2>&1

# Get current time
timestamp=$(date +%s)
<% node[:tile][:styles].each_key do |style| -%>

# Define function to update tiles from z0 to z12 for style "<%= style %>"
function update_<%= style %>
{
  render_old \
    --timestamp=${timestamp} \
    --tile-dir=/srv/tile.openstreetmap.org/tiles \
    --socket=/var/run/renderd/renderd.sock \
    --num-threads=<%= [4, node.dig('cpu', 'total').to_i - 1, node.dig('cpu', 'cores').to_i - 1].max %> \
    --map="<%= style %>" \
    --max-load=<%= [4, node.dig('cpu', 'total').to_i, node.dig('cpu', 'cores').to_i].max %> \
    --min-zoom=0 --max-zoom=12
}

# Loop running the update command until it suceeds
until update_<%= style %>
do
  sleep 30
done
<% end -%>

exit 0
